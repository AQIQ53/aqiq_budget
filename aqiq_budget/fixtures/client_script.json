[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Monthly Budget Distribution Tool",
  "enabled": 1,
  "modified": "2024-06-11 10:57:02.026511",
  "module": "Aqiq Budget",
  "name": "Monthly Budget Distribution Tool",
  "script": "frappe.ui.form.on('Monthly Budget Distribution Tool', {\n \n\n before_save(frm){\n     if(frm.doc.applicable_on_material_request===1){\n         if(frm.doc.applicable_on_purchase_order===0){\n            frappe.throw('Please enable Applicable on Purchase Order and Applicable on Booking Actual Expenses')\n\n         }\n     }\n     if(frm.doc.applicable_on_purchase_order===1){\n         if(frm.doc.applicable_on_booking_actual_expenses==0){\n              frappe.throw('Please enable Applicable on Booking Actual Expenses')\n         }\n     }\n },\n    monthly_distribution_template: function(frm) {\n        //  console.log(frm.doc.monthly_distribution_template);\n         name=frm.doc.monthly_distribution_template\n         frm.doc.monthly_budget_distribution_table = [];\n\n        frm.fields_dict['monthly_budget_distribution_table'].grid.refresh();\n        frm.refresh_field('monthly_budget_distribution_table')\n        frappe.call({\n            method: 'aqiq_budget.aqiq_budget.doctype.monthly_budget_distribution_tool.monthly_budget_distribution_tool.get_period',\n            args: {\n                'name': name\n            },\n            callback: function(r) {\n                if (!r.exc) {\n                    var periods = r.message;\n        \n                    if (frm.fields_dict['monthly_budget_distribution_table']) {\n                        let grid = frm.fields_dict['monthly_budget_distribution_table'].grid;\n                        // grid.remove_all()\n                        periods.forEach(function(periodArray, index) {\n                            if (index < 12) {\n                                // console.log(\"Period \" + (index + 1) + \":\");\n                                periodArray.forEach(function(period) {\n                                    // console.log(period);\n                                    if (grid.fields_map['year_' + (index + 1)]) {\n                                        let field = grid.fields_map['year_' + (index + 1)];\n                                        field.label = period;\n                                        // console.log('Field label updated to ' + period);\n                                        if (field.hidden) {\n                                            field.hidden = 0;\n                                        }\n                                        field.read_only = 0;\n                                    } else {\n                                        console.error(\"Field 'year_\" + (index + 1) + \"' not found in the child table 'monthly_budget_distribution_table'\");\n                                    }\n                                });\n                            }\n                        });\n                        grid.refresh();\n                        console.log('Grid refreshed');\n                    } else {\n                        console.error(\"Child table 'monthly_budget_distribution_table' not found in the form\");\n                    }\n                }\n            }\n        });\n\n\n\n    },\n\trefresh(frm) {\n\t\t// your code here\n\t\tconsole.log(frm.doc.monthly_budget_distribution_table)\n        frm.set_query(\"account\", \"monthly_budget_distribution_table\", function() {\n\t\t\treturn {\n\t\t\t\tfilters: {\n\t\t\t\t\tcompany: frm.doc.company,\n\t\t\t\t\treport_type: \"Profit and Loss\",\n\t\t\t\t\tis_group: 0\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t\tif(frm.doc.monthly_budget_distribution_table==undefined){\n\t\t    \n\t\t}else{\n\t\t    \n\t\t\n\t\t frappe.call({\n            method: 'aqiq_budget.aqiq_budget.doctype.monthly_budget_distribution_tool.monthly_budget_distribution_tool.get_period',\n            args: {\n                'name': name\n            },\n            callback: function(r) {\n                if (!r.exc) {\n                    var periods = r.message;\n        \n                    if (frm.fields_dict['monthly_budget_distribution_table']) {\n                        let grid = frm.fields_dict['monthly_budget_distribution_table'].grid;\n                        // grid.remove_all()\n                        periods.forEach(function(periodArray, index) {\n                            for (let i = 0; i < 12; i++) {\n                                let field = grid.fields_map['year_' + (i + 1)];\n                                if (field) {\n                                    if (periods[i]) {\n                                        field.label = periods[i];\n                                        if (field.hidden) {\n                                            field.hidden = 0;\n                                        }\n                                        field.read_only = 0;\n                                    } else {\n                                        field.label = ''; // Clear label if no period data\n                                        field.hidden = 1; // Optionally hide the field\n                                        field.read_only = 0;\n                                    }\n                                } else {\n                                    console.error(\"Field 'year_\" + (i + 1) + \"' not found in the child table 'monthly_budget_distribution_table'\");\n                                }\n                            }\n                            grid.refresh();\n\n                        });\n                        grid.refresh();\n                        // console.log('Grid refreshed');\n                    } else {\n                        console.error(\"Child table 'monthly_budget_distribution_table' not found in the form\");\n                    }\n                }\n            }\n        });}\n\t},\n\ton_submit(frm){\n\t   console.log(frm.doc.monthly_budget_distribution_table)\n\t   frappe.call({\n            method: 'aqiq_budget.aqiq_budget.doctype.monthly_budget_distribution_tool.monthly_budget_distribution_tool.get_period',\n            args: {\n                'name': name\n            },\n            callback: function(r) {\n                if (!r.exc) {\n                    var periods = r.message;\n        \n                    if (frm.fields_dict['monthly_budget_distribution_table']) {\n                        let grid = frm.fields_dict['monthly_budget_distribution_table'].grid;\n                        // grid.remove_all()\n                        periods.forEach(function(periodArray, index) {\n                            for (let i = 0; i < 12; i++) {\n                                let field = grid.fields_map['year_' + (i + 1)];\n                                if (field) {\n                                    if (periods[i]) {\n                                        field.label = periods[i];\n                                        if (field.hidden) {\n                                            field.hidden = 0;\n                                        }\n                                        field.read_only = 0;\n                                    } else {\n                                        field.label = ''; // Clear label if no period data\n                                        field.hidden = 1; // Optionally hide the field\n                                        field.read_only = 0;\n                                    }\n                                } else {\n                                    console.error(\"Field 'year_\" + (i + 1) + \"' not found in the child table 'monthly_budget_distribution_table'\");\n                                }\n                            }\n                            grid.refresh();\n\n                        });\n                        grid.refresh();\n                        // console.log('Grid refreshed');\n                    } else {\n                        console.error(\"Child table 'monthly_budget_distribution_table' not found in the form\");\n                    }\n                }\n            }\n        });\n        console.log(frm.doc.monthly_budget_distribution_table)\n\n                frappe.call({\n                    method: 'aqiq_budget.aqiq_budget.doctype.monthly_budget_distribution_tool.monthly_budget_distribution_tool.create_budget',\n                    args: {\n                      'name':frm.doc.name\n                    },\n                    callback: function(r) {\n                        if (!r.exc) {\n                            // code snippet\n                        }\n                    }\n                });\n\n\t\n\t   // frm.refresh_field(\"monthly_budget_distribution_table\");\n\t}\n})\n\nfrappe.ui.form.on('Monthly Budget Distribution Table', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\t\n})",
  "view": "Form"
 }
]